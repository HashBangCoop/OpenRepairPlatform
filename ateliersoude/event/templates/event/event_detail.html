{% extends 'base.html' %}
{% load assets l10n app_filters %}

{% block extra_css %}
  {% assets "css_detail_event" %}
    <link type="text/css" href="{{ ASSET_URL }}" rel="stylesheet"/>
  {% endassets %}
{% endblock %}

{% block content %}
  {% url "event:list" as event_list_url %}
  {% include "breadcrumb.html" with current=event first_parent_url=event_list_url first_parent_text="Évènements" %}
  <div class="jumbotron jumbotron-fluid">
    <div class="container">
      <h1 class="display-4">{{ event }}</h1>
      <p class="lead">
        - Organisé par
        <a href="{% url 'user:organization_detail' event.organization.id event.organization.slug %}">
          {{ event.organization.name }}
        </a>
      </p>
      <div class="lead">
        <a href="{% url 'event:edit' event.pk event.organization.pk %}" class="btn btn-warning btn-sm"><i class="fa fa-pencil-alt"></i> Éditer</a>
        <a href="{% url 'event:delete' event.pk %}" class="btn btn-danger btn-sm"><i class="fa fa-trash"></i> Supprimer</a>
        <form action="{% url 'event:close' event.pk %}" method="post" class="d-inline">
          {% csrf_token %}
          <button class="btn btn-sm btn-info" type="submit" onclick="return confirm('Êtes-vous sûrs de vouloir clôturer l\'évènement?')">
            <i class="fa fa-calendar-check"></i>
            Clôturer
          </button>
        </form>
      </div>
    </div>
  </div>
  <section class="container">
    <div class="card">
      <div class="row pl-3 pr-3">
        <div class="card-body col-lg-6">

          <h6 class="card-subtitle text-muted">
            {% if event.remaining_seats == 0 %}
              <span class="badge badge-warning badge-pill">Complet</span>
            {% else %}
              Encore
              <span class="badge badge-info badge-pill">{{ event.remaining_seats }}
                </span> places disponibles
            {% endif %}
            {% if request.user in event.registered.all or request.user in event.presents.all %}
              <span class="badge badge-success badge-pill">Inscrit</span>
            {% endif %}
          </h6>

          <p class="pt-3">
            {{ event.activity.description }}
          </p>
          <p>
            <i class="fa fa-calendar-alt"></i> 
            Début le {{ event.date_interval_format }} 
          </p>

          <hr>

          <b>Condition(s) de venue:</b>
          <ul class="pt-3">
            {% for condition in event.conditions.all %}
              <li>
                {% if condition.price > 0 %}
                  <span class="badge badge-pill badge-secondary">{{ condition.price }}€</span> -
                {% endif %}
                {{ condition.description }}
              </li>
              {% empty %}
              <li>La participation est libre / pas de condition d'accès</li>
            {% endfor %}
          </ul>

          <a href="{% url 'event:activity_detail' event.activity.pk event.activity.slug %}" class="btn btn-info">
            <i class="fa fa-eye"></i>
            En savoir plus sur l'activité
          </a>
          {% include "event/register.html" with event=event %}
        </div>

        <div class="card-body col-lg-6 p-0">
          <div style="height:100%; min-height: 250px" id="event_map"></div>
        </div>
      </div>

      <div class="card-footer">
        <small>
          Organisé par
          <a href="{% url 'user:organization_detail' event.organization.id event.organization.slug %}">
            {{ event.organization.name }}
          </a>

          <br>
          <i class="fa fa-map-marker"></i>
          <a href="{% url 'location:detail' event.location.id event.location.slug %}">
            {{ event.location.name }}</a>,
          {{ event.location.address }}
        </small>
      </div>

      {% if event.activity.picture %}
        <img class="img-responsive w-100" src="{{ event.activity.picture.url }}" alt="activity illustration">
      {% endif %}
    </div>
  </section>

  <section class="container">
    <h5 class="mt-4">Animateur·trice·s</h5>
    <hr>

    <div class="row">
    {% for user in event.organizers.all %}
      <div class="col-3 p-2">
        <div class="card">
          <a href="{% url "user:user_detail" user.pk %}" class="card-link">
            <div class="card-body text-center p-4">
              <i class="fa fa-user fa-4x"></i><br>
              {{ user }}
            </div>
          </a>
        </div>
      </div>
    {% endfor %}
    </div>

    <h5>Participant·e·s</h5>
    <hr>
    {# TODO: display only if request.user > volunteer #}

    {% if event.has_started %}
      <a href="#" class="btn btn-success btn-sm" onclick="alert('not implemented')"><i class="fa fa-plus"></i> Un membre est présent</a>
    {% endif %}
    {% if not event.has_ended %}
      <a href="#" class="btn btn-success btn-sm" onclick="alert('not implemented')"><i class="fa fa-plus"></i> Inscrire un membre</a>
    {% endif %}

    <div class="row">
      {% for user in event.registered.all %}
        <div class="col-3 p-2">
          <div class="card">
            <div class="card-body text-center p-4">
              <a href="{% url "user:user_detail" user.pk %}" class="card-link">
                <i class="fa fa-user fa-4x"></i><br>
                {{ user }}<br>
              </a>
              {% if event.has_started %}
                {% tokenize user=user event=event action='present' as tok %}
                <a href="{% url 'event:user_present' tok %}" class="btn btn-success btn-sm">
                  <i class="fa fa-plus"></i>
                  Présent
                </a>
              {% endif %}
              {% tokenize user=user event=event action='cancel' as tok %}
              <a href="{% url 'event:cancel_reservation' tok %}" class="btn btn-danger btn-sm">
                <i class="fa fa-minus"></i>
                Désinscrire
              </a>
            </div>
          </div>
        </div>
      {% endfor %}

      {% for user in event.presents.all %}
        <div class="col-3 p-2">
          <div class="card">
            <div class="card-body text-center p-4">
              <a href="{% url "user:user_detail" user.pk %}" class="card-link">
                <i class="fa fa-user fa-4x"></i><br>
                {{ user }}<br>
              </a>
              {% tokenize user=user event=event action='absent' as tok %}
              <a href="{% url 'event:user_absent' tok %}" class="btn btn-danger btn-sm">
                <i class="fa fa-minus"></i>
                Absent
              </a>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>

  </section>

{% endblock %}

{% block extra_js %}
  <script>
      const longitude = {{ event.location.longitude|unlocalize }};
      const latitude = {{ event.location.latitude|unlocalize }};
  </script>
  {% assets "js_detail_event" %}
    <script src="{{ ASSET_URL }}"></script>
  {% endassets %}
{% endblock %}
